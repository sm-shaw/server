name: Sync New Upstream Branches and Notify

permissions:
  contents: write

on:
  schedule:
    - cron: '0 2 * * *'  # daily at 2am UTC
  workflow_dispatch:
    inputs:
      webhook_url:
        description: 'Webhook URL to notify on new branch'
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your fork
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Git user
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Add upstream remote if missing
        run: |
          git remote get-url upstream || git remote add upstream https://github.com/MariaDB/server.git

      - name: Fetch all remotes
        run: git fetch --all

      - name: Cache upstream branch history
        uses: actions/cache@v4
        id: upstream-cache
        with:
          path: .github/upstream-branches.txt
          key: upstream-history-${{ github.run_id }}
          restore-keys: |
            upstream-history-

      - name: Sync branches and notify webhook
        env:
          WEBHOOK_URL: ${{ github.event.inputs.webhook_url }}
        run: |
          set -euo pipefail

          echo "üîÅ Preparing environment..."
          FORK_REMOTE=origin
          UPSTREAM_REMOTE=upstream
          TRACK_FILE=".github/upstream-branches.txt"
          mkdir -p .github
          touch "$TRACK_FILE"

          echo "üì• Getting current branch lists..."
          mapfile -t upstream_branches < <(git for-each-ref --format='%(refname:strip=3)' refs/remotes/$UPSTREAM_REMOTE)
          mapfile -t fork_branches < <(git for-each-ref --format='%(refname:strip=3)' refs/remotes/$FORK_REMOTE)

          DEFAULT_BRANCH=$(git remote show origin | awk '/HEAD branch/ {print $NF}')

          # Load previously known upstream branches into associative array
          declare -A previous_upstream
          while IFS= read -r branch; do
            previous_upstream["$branch"]=1
          done < "$TRACK_FILE"

          webhook_post() {
            local ref="$1"
            local ref_type="branch"
            if [[ -z "$WEBHOOK_URL" ]]; then
              echo "‚ùå WEBHOOK_URL is empty ‚Äî skipping webhook."
              return
            fi
            echo "üì° Sending webhook for $ref to $WEBHOOK_URL"
            if ! curl -X POST -H "X-GitHub-Event: create" -H "Content-Type: application/json" \
              -d "{\"ref\":\"$ref\", \"ref_type\":\"$ref_type\"}" \
              "$WEBHOOK_URL"; then
              echo "‚ö†Ô∏è Failed to send webhook to $WEBHOOK_URL"
            fi
          }

          echo "üîÑ Checking for new upstream branches to sync..."
          for branch in "${upstream_branches[@]}"; do
            if [[ ! " ${fork_branches[*]} " =~ " ${branch} " ]]; then
              echo "‚û°Ô∏è New upstream branch detected: $branch"
              git checkout -b "$branch" "$UPSTREAM_REMOTE/$branch"
              if git ls-tree -r --name-only HEAD | grep -q '^.github/workflows/'; then
                echo "‚ö†Ô∏è Branch $branch modifies workflows ‚Äî skipping push"
              else
                if git push "$FORK_REMOTE" "$branch"; then
                  echo "‚úÖ Pushed $branch to fork"
                  webhook_post "refs/heads/$branch"
                else
                  echo "‚ö†Ô∏è Failed to push $branch"
                fi
              fi
              git checkout "$DEFAULT_BRANCH"
              git branch -D "$branch"
            else
              echo "‚úÖ Branch $branch already exists in fork"
            fi
          done

          echo "üîÅ Updating tracked upstream branch history..."
          printf "%s\n" "${upstream_branches[@]}" | sort > "$TRACK_FILE"

          echo "üîç Checking fork-only branches..."
          for branch in "${fork_branches[@]}"; do
            if [[ "$branch" == "$DEFAULT_BRANCH" ]]; then
              echo "‚ÑπÔ∏è Skipping default branch: $branch"
              continue
            fi

            branch_is_upstream=false
            for ub in "${upstream_branches[@]}"; do
              if [[ "$ub" == "$branch" ]]; then
                branch_is_upstream=true
                break
              fi
            done

            if ! $branch_is_upstream; then
              if [[ -z "${previous_upstream["$branch"]+x}" ]]; then
                echo "üÜï Fork-only branch $branch has never existed upstream ‚Äî triggering webhook"
                webhook_post "refs/heads/$branch"
              else
                echo "üßπ Deleting stale fork-only branch: $branch"
                git push "$FORK_REMOTE" --delete "$branch" || echo "‚ö†Ô∏è Failed to delete $branch"
              fi
            fi
          done
